<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lianchuangjie.lianchuangjie.mapper.StockRank.StockRankMapper">
    <select id="selectList" resultType="com.lianchuangjie.lianchuangjie.vo.StockRank.StockRankVO">
        SELECT
            U_StockRank.*,
            ISNULL(StockQuantity.Quantity, 0) AS Quantity, /*现有库存数量*/
            ISNULL(OpenQuantity.OpenQty, 0) AS OpenQty /*在途库存数量*/
        FROM U_StockRank
        /*现有库存数量*/
        LEFT JOIN (
            SELECT
                T_OBTN.ItemName,
                SUM(
                    CASE
                        WHEN T.Quantity = 0 THEN 0
                        WHEN T.Quantity &lt; T_OBTN.U_LockQty THEN T.Quantity
                        ELSE T_OBTN.U_LockQty
                    END
                ) AS Quantity
            FROM (
                SELECT
                    MdAbsEntry,
                    SUM(Quantity) AS Quantity
                FROM T_OBTQ
                GROUP BY MdAbsEntry
            ) T
            INNER JOIN T_OBTN ON T.MdAbsEntry = T_OBTN.AbsEntry
            GROUP BY ItemName
        ) StockQuantity ON StockQuantity.ItemName = U_StockRank.Modle
        /*在途库存数量*/
        LEFT JOIN (
            SELECT
                T_OPOR1.U_ItemName,
                T_OPOR1.U_Brand,
                SUM(T_OPOR1.OpenQty) AS OpenQty
            FROM T_OPOR1
            WHERE U_AreaType = 2 AND LineStatus ='O'
            GROUP BY T_OPOR1.U_ItemName, T_OPOR1.U_Brand
        ) OpenQuantity ON OpenQuantity.U_ItemName = U_StockRank.Modle AND OpenQuantity.U_Brand = U_StockRank.Brand
        ORDER BY U_StockRank.TotalScore DESC
    </select>
    <select id="selectPurchasePrice" resultType="java.math.BigDecimal">
        SELECT PPriceAFVAT
        FROM U_OIVL
        WHERE BaseName = N'采购入库'
        AND DATEDIFF(MONTH , DocDate, GETDATE()) &lt;= 2
        <if test="modle != null">
            AND ItemName = #{modle}
        </if>
    </select>
</mapper>